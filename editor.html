<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Canvas Gradient + Text Overlay</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#9aa6b2;
    --accent:#60a5fa;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,color-scheme:dark;color:#e6eef6;background:linear-gradient(180deg,#071024 0%, #07121b 60%);-webkit-font-smoothing:antialiased}
  /* Sign-in bar */
  .signin-bar {
    max-width:1150px;
    margin:18px auto 6px;
    padding:10px 14px;
    border-radius:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .signin-left {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand {
    font-weight:700;
    color:var(--accent);
    font-size:16px;
    margin-right:8px;
  }
  .signin-form { display:flex; align-items:center; gap:8px; }
  .signin-form input[type="email"],
  .signin-form input[type="password"] {
    background:#071826;color:#dbe9f6;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;
    font-size:13px;
  }
  .signin-form button {
    background-color: #e27979;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
  }
  .signin-actions { display:flex; gap:8px; align-items:center; }
  .signin-actions a { color:var(--muted); text-decoration:none; font-size:13px; }
  .wrap{
    max-width:1150px;margin:28px auto;padding:18px;border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow:0 6px 30px rgba(0,0,0,0.6);
    display:grid;grid-template-columns: 420px 1fr;gap:18px;
  }
  .panel{background:var(--card);padding:14px;border-radius:10px;}
  h1{font-size:18px;margin:0 0 10px;color:var(--accent)}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  .controls{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px;align-items:center}
  input[type=color]{height:36px;width:56px;padding:0;border-radius:6px;border:0;cursor:pointer}
  input[type=range]{width:100%}
  select,button,input[type=file],input[type=text],input[type=number],input[type=date],textarea {
    background:#071826;color:#dbe9f6;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;
  }
  button{cursor:pointer}
  .canvas-wrap{display:flex;flex-direction:column;gap:10px}
  .stage{position:relative;background:#0a1724;border-radius:8px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center}
  canvas{max-width:100%;height:auto;border-radius:6px;}
  #mainCanvas { background: white; }
  #drawingCanvas { position: absolute; top: 12px; left: 12px; pointer-events: none; }
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .buttons{display:flex;gap:6px;margin-top:10px}
  .small{font-size:12px;padding:7px 10px}
  footer{grid-column:1/-1;margin-top:6px;font-size:12px;color:var(--muted);text-align:center}
  .file-drag{border:2px dashed rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;color:var(--muted)}
  .upload-status { font-size:13px; color:var(--muted); margin-top:8px; }
  .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8)}.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);padding:20px;border-radius:12px;width:90%;max-width:800px;max-height:80vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.modal-close{font-size:24px;color:var(--muted);cursor:pointer;background:none;border:none;padding:0}.modal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}.modal-thumb{width:100%;height:100px;object-fit:cover;border-radius:8px;cursor:pointer;opacity:.8;transition:opacity .2s}.modal-thumb:hover{opacity:1}
  .tool-btn.active { background-color: var(--accent); color: var(--card); }

  @media(max-width:980px){
    .wrap{grid-template-columns:1fr; padding:12px}
    .signin-bar { max-width: calc(100% - 24px); margin: 12px; flex-direction: column; gap:8px; align-items:stretch; }
    .signin-form { justify-content:space-between; }
  }
</style>
</head>
<body>

<div class="signin-bar" role="navigation" aria-label="Sign in bar">
  <div class="signin-left">
    <div class="brand">digital artist database</div>
    <div style="font-size:13px;color:var(--muted)">Canvas Editor</div>
  </div>
  <div id="signin-container">
    <form class="signin-form" method="POST" action="testy8.php" style="margin-left:auto;">
      <input type="email" name="email" placeholder="email" aria-label="email" required>
      <input type="password" name="password" placeholder="password" aria-label="password" required>
      <button type="submit" name="login">Login</button>
    </form>
  </div>
  <div id="user-info" style="display:none;">
    <span id="user-greeting"></span>
    <a href="testy8.php?logout=1" style="margin-left:12px;font-size:13px;">Logout</a>
  </div>
  <a href="register.php" id="register-link">Register</a>
</div>

<div class="wrap">
  <div class="panel">
    <h1>Overlay Controls</h1>
    <div class="controls">
      <label>Image</label>
      <div class="row">
        <input id="fileInput" type="file" accept="image/*" style="flex-grow: 1;" />
        <button id="loadFromProfileBtn" class="small" style="display:none;">Load from Profile</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0;">
      <label>Tools</label>
      <div class="row">
        <button id="toolGradient" class="small tool-btn active">Gradient/Text</button>
        <button id="toolPencil" class="small tool-btn">Pencil</button>
      </div>

      <div id="pencilControls" style="display:none;">
          <label>Pencil Color & Size</label>
          <div class="row">
              <input id="pencilColor" type="color" value="#ff0000" />
              <input id="pencilSize" type="range" min="1" max="50" step="1" value="5" />
              <span id="pencilSizeVal" style="width:38px;text-align:right;font-size:12px;color:var(--muted)">5</span>
          </div>
      </div>
      
      <label style="margin-top:14px">Gradient Overlay</label>
      <div class="row">
        <input id="startColor" type="color" value="#000000" />
        <input id="startAlpha" type="range" min="0" max="1" step="0.01" value="0.6" />
        <span id="startAlphaVal" style="width:38px;text-align:right;font-size:12px;color:var(--muted)">0.60</span>
      </div>
      <div class="row">
        <input id="endColor" type="color" value="#000000" />
        <input id="endAlpha" type="range" min="0" max="1" step="0.01" value="0" />
        <span id="endAlphaVal" style="width:38px;text-align:right;font-size:12px;color:var(--muted)">0.00</span>
      </div>
      <label>Blend Mode</label>
      <select id="blendMode">
        <option value="source-over">Normal</option><option value="multiply">Multiply</option><option value="screen">Screen</option><option value="overlay">Overlay</option><option value="lighter">Lighter</option><option value="darken">Darken</option><option value="lighten">Lighten</option>
      </select>
      <div class="row">
        <button id="linearBtn" class="small">Linear</button><button id="radialBtn" class="small">Radial</button><button id="clearBtn" class="small">Clear Gradient</button>
      </div>

      <label style="margin-top:14px">Text Overlay</label>
      <input id="overlayText" type="text" placeholder="Enter overlay text" value="Sample Text" />
      <div class="row"><label style="flex:1">Font Size</label><input id="fontSize" type="number" min="10" max="200" value="64" style="width:80px"></div>
      <div class="row"><input id="textColor" type="color" value="#ffffff" /><input id="textAlpha" type="range" min="0" max="1" step="0.01" value="1" /><span id="textAlphaVal" style="width:38px;text-align:right;font-size:12px;color:var(--muted)">1.00</span></div>
      <label>Text Blend Mode</label>
      <select id="textBlend">
        <option value="source-over">Normal</option><option value="overlay">Overlay</option><option value="lighten">Lighten</option><option value="darken">Darken</option><option value="screen">Screen</option><option value="multiply">Multiply</option>
      </select>
      <button id="resetBtn" class="small">Reset All</button>
      <button id="downloadBtn" class="small">Download PNG</button>

      <div class="hint">⬇ Click & drag for gradient. ✍️ Drag text to move. ✏️ Use Pencil tool to draw.</div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0;">
      <h1 style="font-size:16px;">Save to Your Profile</h1>
      <div id="upload-panel" style="display:none;">
        <label>Description</label><input id="upload_desc" type="text" placeholder="Work description">
        <label>Date of Work</label><input id="upload_date" type="date">
        <div style="display:flex;gap:8px;margin-top:8px;"><button id="upload_work_btn" class="small">Save to Profile</button></div>
        <div id="upload_status" class="upload-status"></div>
      </div>
      <div id="upload-login-prompt" class="hint">Log in to save your creations to your profile.</div>
    </div>
  </div>

  <div class="panel canvas-wrap">
    <h1>Canvas</h1>
    <div class="stage">
      <canvas id="mainCanvas" width="880" height="550"></canvas>
      <canvas id="drawingCanvas" width="880" height="550"></canvas>
      <div class="hint file-drag" id="dropHint">Drop image file onto the canvas</div>
    </div>
    <div class="buttons" style="justify-content:center">
      <div class="hint" id="status">White canvas ready. Load an image or start drawing.</div>
    </div>
  </div>

  <footer>Canvas Gradient + Text Overlay — HTML, CSS & JavaScript only</footer>
</div>

<!-- Modal for loading work from profile -->
<div id="profileWorkModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header"><h1_>Load Work from Your Profile</h1_><button id="modalCloseBtn" class="modal-close">&times;</button></div>
    <div id="modalGrid" class="modal-grid"></div>
  </div>
</div>


<script>
(function(){
  const mainCanvas = document.getElementById('mainCanvas'), mainCtx = mainCanvas.getContext('2d');
  const drawingCanvas = document.getElementById('drawingCanvas'), drawCtx = drawingCanvas.getContext('2d');
  const fileInput = document.getElementById('fileInput'), status = document.getElementById('status'), dropHint = document.getElementById('dropHint');
  const startColorInput = document.getElementById('startColor'), endColorInput = document.getElementById('endColor');
  const startAlphaInput = document.getElementById('startAlpha'), endAlphaInput = document.getElementById('endAlpha');
  const startAlphaVal = document.getElementById('startAlphaVal'), endAlphaVal = document.getElementById('endAlphaVal');
  const blendModeSelect = document.getElementById('blendMode'), clearBtn = document.getElementById('clearBtn');
  const resetBtn = document.getElementById('resetBtn'), downloadBtn = document.getElementById('downloadBtn');
  const linearBtn = document.getElementById('linearBtn'), radialBtn = document.getElementById('radialBtn');
  const overlayTextInput = document.getElementById('overlayText'), fontSizeInput = document.getElementById('fontSize');
  const textColorInput = document.getElementById('textColor'), textAlphaInput = document.getElementById('textAlpha');
  const textAlphaVal = document.getElementById('textAlphaVal'), textBlendSelect = document.getElementById('textBlend');
  const uploadDesc = document.getElementById('upload_desc'), uploadDate = document.getElementById('upload_date');
  const uploadBtn = document.getElementById('upload_work_btn'), uploadStatus = document.getElementById('upload_status');
  const loadFromProfileBtn = document.getElementById('loadFromProfileBtn');
  const profileWorkModal = document.getElementById('profileWorkModal'), modalGrid = document.getElementById('modalGrid'), modalCloseBtn = document.getElementById('modalCloseBtn');
  const toolGradientBtn = document.getElementById('toolGradient'), toolPencilBtn = document.getElementById('toolPencil');
  const pencilControls = document.getElementById('pencilControls'), pencilColorInput = document.getElementById('pencilColor'), pencilSizeInput = document.getElementById('pencilSize'), pencilSizeVal = document.getElementById('pencilSizeVal');

  let img = new Image(); img.crossOrigin = "anonymous";
  let imgLoaded = false, isDrawing = false, isDraggingGradient = false, isMovingText = false;
  let gradientStart = null, gradientEnd = null, gradientMode = 'linear', gradientComposite = 'source-over';
  let textLayer = { text: 'Sample Text', x: mainCanvas.width/2, y: mainCanvas.height/2, fontSize: 64, color: '#ffffff', alpha: 1, blend: 'source-over' };
  let textMoveOffset = {x:0, y:0};
  let lastPos = {x:0, y:0};
  let currentTool = 'gradient'; // 'gradient', 'pencil'
  let userProfileData = null;

  function setStatus(s){ status.textContent = s; }
  function rgba(hex,a){ const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }

  function drawMainCanvas(){
    mainCtx.clearRect(0,0,mainCanvas.width,mainCanvas.height);
    mainCtx.fillStyle = 'white';
    mainCtx.fillRect(0,0,mainCanvas.width,mainCanvas.height);
    if(imgLoaded) mainCtx.drawImage(img,0,0,mainCanvas.width,mainCanvas.height);
    
    if(gradientStart && gradientEnd){
      mainCtx.save(); mainCtx.globalCompositeOperation = gradientComposite;
      const sc=rgba(startColorInput.value,startAlphaInput.value), ec=rgba(endColorInput.value,endAlphaInput.value);
      let g;
      if(gradientMode==='linear') g=mainCtx.createLinearGradient(gradientStart.x,gradientStart.y,gradientEnd.x,gradientEnd.y);
      else { const r=Math.hypot(gradientEnd.x-gradientStart.x,gradientEnd.y-gradientStart.y); g=mainCtx.createRadialGradient(gradientStart.x,gradientStart.y,0,gradientStart.x,gradientStart.y,r); }
      g.addColorStop(0,sc); g.addColorStop(1,ec); mainCtx.fillStyle=g; mainCtx.fillRect(0,0,mainCanvas.width,mainCanvas.height); mainCtx.restore();
    }
    if(textLayer.text){
      mainCtx.save(); mainCtx.globalCompositeOperation=textLayer.blend; mainCtx.font=`${textLayer.fontSize}px sans-serif`;
      mainCtx.textAlign='center'; mainCtx.textBaseline='middle'; mainCtx.fillStyle=rgba(textLayer.color,textLayer.alpha);
      mainCtx.fillText(textLayer.text,textLayer.x,textLayer.y); mainCtx.restore();
    }
  }

  function toCanvasCoords(e){ const r=mainCanvas.getBoundingClientRect(),cX=e.touches?e.touches[0].clientX:e.clientX,cY=e.touches?e.touches[0].clientY:e.clientY; return {x:(cX-r.left)*(mainCanvas.width/r.width), y:(cY-r.top)*(mainCanvas.height/r.height)}; }
  
  mainCanvas.addEventListener('mousedown',e=>{ 
    const pos=toCanvasCoords(e);
    if (currentTool === 'pencil') {
      isDrawing = true;
      lastPos = pos;
    } else {
      if(isOnText(pos)){ isMovingText=true; textMoveOffset.x=pos.x-textLayer.x; textMoveOffset.y=pos.y-textLayer.y; return; }
      isDraggingGradient=true; gradientStart=pos; gradientEnd={...pos};
    }
  });
  mainCanvas.addEventListener('mousemove',e=>{ 
    const pos=toCanvasCoords(e);
    if(isDrawing) {
      drawCtx.beginPath(); drawCtx.moveTo(lastPos.x, lastPos.y); drawCtx.lineTo(pos.x, pos.y);
      drawCtx.strokeStyle = pencilColorInput.value; drawCtx.lineWidth = pencilSizeInput.value;
      drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round'; drawCtx.stroke();
      lastPos = pos;
    } else if(isMovingText){ 
      textLayer.x=pos.x-textMoveOffset.x; textLayer.y=pos.y-textMoveOffset.y; drawMainCanvas(); 
    } else if (isDraggingGradient) {
      gradientEnd=pos; drawMainCanvas();
    }
  });
  mainCanvas.addEventListener('mouseup',()=>{ isDrawing=false; isMovingText=false; isDraggingGradient=false; });
  mainCanvas.addEventListener('mouseleave',()=>{ isDrawing=false; isMovingText=false; isDraggingGradient=false; });

  function isOnText(p){ mainCtx.font=`${textLayer.fontSize}px sans-serif`; const w=mainCtx.measureText(textLayer.text).width,h=textLayer.fontSize; return(p.x>textLayer.x-w/2&&p.x<textLayer.x+w/2&&p.y>textLayer.y-h/2&&p.y<textLayer.y+h/2); }

  function loadImage(src) {
    img=new Image(); img.crossOrigin="anonymous";
    img.onload=()=>{ imgLoaded=true; mainCanvas.width=drawingCanvas.width=img.width; mainCanvas.height=drawingCanvas.height=img.height; textLayer.x=mainCanvas.width/2; textLayer.y=mainCanvas.height/2; drawMainCanvas(); setStatus(`Image loaded: ${img.width}x${img.height}`); };
    img.onerror=()=>{setStatus('Error loading image.');};
    img.src=src;
  }

  fileInput.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) loadImage(URL.createObjectURL(f)); });
  ['dragenter','dragover'].forEach(ev=>mainCanvas.addEventListener(ev,e=>{e.preventDefault();dropHint.style.borderColor="#3aa0ff"}));
  ['dragleave','drop'].forEach(ev=>mainCanvas.addEventListener(ev,e=>{e.preventDefault();dropHint.style.borderColor=""}));
  mainCanvas.addEventListener('drop',e=>{ const f=e.dataTransfer.files[0]; if(f) loadImage(URL.createObjectURL(f)); });

  // --- CONTROLS ---
  [startColorInput,endColorInput,startAlphaInput,endAlphaInput,blendModeSelect,overlayTextInput,fontSizeInput,textColorInput,textAlphaInput,textBlendSelect].forEach(el=>el.addEventListener('input',drawMainCanvas));
  startAlphaInput.addEventListener('input',()=>{startAlphaVal.textContent=Number(startAlphaInput.value).toFixed(2);});
  endAlphaInput.addEventListener('input',()=>{endAlphaVal.textContent=Number(endAlphaInput.value).toFixed(2);});
  textAlphaInput.addEventListener('input',()=>{textAlphaVal.textContent=Number(textAlphaInput.value).toFixed(2);});
  clearBtn.addEventListener('click',()=>{gradientStart=gradientEnd=null;drawMainCanvas();});
  linearBtn.addEventListener('click',()=>{gradientMode='linear';setStatus('Gradient: linear');});
  radialBtn.addEventListener('click',()=>{gradientMode='radial';setStatus('Gradient: radial');});
  resetBtn.addEventListener('click',()=>{ gradientStart=gradientEnd=null;imgLoaded=false;img=new Image(); textLayer.x=mainCanvas.width/2;textLayer.y=mainCanvas.height/2;textLayer.text="Sample Text"; drawMainCanvas(); drawCtx.clearRect(0,0,drawingCanvas.width,drawingCanvas.height); });
  
  toolGradientBtn.addEventListener('click', () => { currentTool = 'gradient'; toolPencilBtn.classList.remove('active'); toolGradientBtn.classList.add('active'); drawingCanvas.style.pointerEvents = 'none'; pencilControls.style.display = 'none'; });
  toolPencilBtn.addEventListener('click', () => { currentTool = 'pencil'; toolGradientBtn.classList.remove('active'); toolPencilBtn.classList.add('active'); drawingCanvas.style.pointerEvents = 'auto'; pencilControls.style.display = 'block'; });
  pencilSizeInput.addEventListener('input', () => pencilSizeVal.textContent = pencilSizeInput.value);

  downloadBtn.addEventListener('click',()=>{ 
      const tempCanvas=document.createElement('canvas'), tempCtx=tempCanvas.getContext('2d');
      tempCanvas.width=mainCanvas.width; tempCanvas.height=mainCanvas.height;
      tempCtx.drawImage(mainCanvas,0,0); tempCtx.drawImage(drawingCanvas,0,0);
      const l=document.createElement('a'); l.download='canvas.png'; l.href=tempCanvas.toDataURL('image/png'); l.click(); 
  });

  uploadBtn.addEventListener('click', ()=>{
    uploadStatus.textContent = 'Uploading...';
    const tempCanvas=document.createElement('canvas'), tempCtx=tempCanvas.getContext('2d');
    tempCanvas.width=mainCanvas.width; tempCanvas.height=mainCanvas.height;
    tempCtx.drawImage(mainCanvas,0,0); tempCtx.drawImage(drawingCanvas,0,0);
    tempCanvas.toBlob(blob=>{
      const fd=new FormData(); fd.append('upload_work','1'); fd.append('work_desc',uploadDesc.value||'Created with Canvas Editor');
      fd.append('work_date',uploadDate.value||new Date().toISOString().split('T')[0]); fd.append('work_file',blob,'canvas_image.png');
      fetch('studio3.php',{method:'POST',body:fd,credentials:'same-origin'})
      .then(()=>{ uploadStatus.textContent='Upload successful! Redirecting...'; setTimeout(()=>window.location.href='studio3.php',1000); })
      .catch(err=>{ uploadStatus.textContent='Upload error: '+err.message; });
    }, 'image/png');
  });

  loadFromProfileBtn.addEventListener('click', () => {
    if (!userProfileData||!userProfileData.work||userProfileData.work.length===0){ alert("No images found in your profile."); return; }
    modalGrid.innerHTML='';
    userProfileData.work.forEach(work=>{
        if (work.type!=='image'&&!/\.(jpg|jpeg|png|gif)$/i.test(work.path)) return;
        const thumb=document.createElement('img'); thumb.src=work.path.replace(/^\/var\/www\/html\//,'');
        thumb.className='modal-thumb'; thumb.title=work.desc;
        thumb.onclick=()=>{ loadImage(thumb.src); profileWorkModal.style.display='none'; };
        modalGrid.appendChild(thumb);
    });
    profileWorkModal.style.display = 'block';
  });
  modalCloseBtn.addEventListener('click',()=>profileWorkModal.style.display='none');
  profileWorkModal.addEventListener('click',e=>{if(e.target===profileWorkModal)profileWorkModal.style.display='none';});

  document.addEventListener('DOMContentLoaded', () => {
    fetch('get_session.php').then(res=>res.json()).then(data=>{
      if(data.loggedIn){
        document.getElementById('signin-container').style.display='none'; document.getElementById('register-link').style.display='none';
        const userInfo=document.getElementById('user-info'); userInfo.style.display='flex';
        document.getElementById('user-greeting').textContent=`Welcome, ${data.first}!`;
        document.getElementById('upload-panel').style.display='block'; document.getElementById('upload-login-prompt').style.display='none';
        loadFromProfileBtn.style.display='block'; userProfileData=data.profile;
      }
    });
    drawMainCanvas();
  });
})();
</script>
</body>
</html>
